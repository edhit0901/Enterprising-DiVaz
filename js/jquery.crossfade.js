(function(factory){'use strict';if(typeof define==='function'&&define.amd){define(['jquery'],factory);}else{factory(window.jQuery||window.Zepto);}}(function($){'use strict';function Crossfade(el,options){this.el=$(el);this.options=options||{};this.options.start=this.options.start||this.el.data('crossfade-start');this.options.end=this.options.end||this.el.data('crossfade-end');if(!this.options.start||!this.options.end){throw new Error('crossfade.js requires two images.');}
var position=this.options.backgroundPosition.split(' ');this.options.backgroundPositionX=position[0];this.options.backgroundPositionY=position[1];this.width=this.el.width();this.height=this.el.height();this.canvas=$('<canvas>').css({position:'absolute',top:'0',left:'0',width:this.width,height:this.height});this.canvas.appendTo(this.el);this.paintbrush=this.canvas[0].getContext('2d');var onScroll=$.proxy(this.onScroll,this);var onResize=$.proxy(this.onResize,this);this.preload(function(){$(window).on('scroll',onScroll).trigger('scroll');$(window).on('resize',onResize).trigger('resize');});}
Crossfade.prototype.preload=function(callback){var sources,remaining,loaded;this.start=$('<img>').attr({src:this.options.start});this.end=$('<img>').attr({src:this.options.end});sources=[this.start,this.end];remaining=sources.length;loaded=function(){remaining--;if(remaining===0){if(typeof callback==='function'){callback();}}};for(var i=0;i<sources.length;i++){sources[i].on('load',loaded);if(sources[i].prop('complete')){sources[i].trigger('load');}}};Crossfade.prototype.resize=function(){this.needsResize=false;this.canvas[0].width=this.width;this.canvas[0].height=this.height;this.canvas.css({width:this.width,height:this.height});};Crossfade.prototype.draw=function(){var dimensions;if(this.needsResize){this.resize();}
dimensions=this.getDrawDimensions(this.start[0].width,this.start[0].height,this.width,this.height);this.paintbrush.drawImage(this.start[0],dimensions.offset.x,dimensions.offset.y,dimensions.width,dimensions.height);this.paintbrush.globalAlpha=this.visibility;this.paintbrush.drawImage(this.end[0],dimensions.offset.x,dimensions.offset.y,dimensions.width,dimensions.height);this.paintbrush.globalAlpha=1;this.ticking=false;};Crossfade.prototype.getDrawDimensions=function(imageWidth,imageHeight,containerWidth,containerHeight){var dimensions={};var imageRatio=imageHeight/imageWidth;var containerRatio=containerHeight/containerWidth;if(containerRatio>imageRatio){dimensions.width=parseInt(containerHeight/imageRatio);dimensions.height=parseInt(containerHeight);}else{dimensions.width=parseInt(containerWidth);dimensions.height=parseInt(containerWidth*imageRatio);}
dimensions.offset={};switch(this.options.backgroundPositionY){case 'top':dimensions.offset.y=0;break;case 'bottom':dimensions.offset.y=(dimensions.height-containerHeight)*-1;break;case 'center':default:dimensions.offset.y=(dimensions.height-containerHeight)/-2;break;}
switch(this.options.backgroundPositionX){case 'left':dimensions.offset.x=0;break;case 'right':dimensions.offset.x=(dimensions.width-containerWidth)*-1;break;case 'center':default:dimensions.offset.x=(dimensions.width-containerWidth)/-2;break;}
return dimensions;};Crossfade.prototype.onScroll=function(){var scrollTop=$(window).scrollTop();var elementOffsetTop=this.el.offset().top;var elementHeight=this.el.height();var percentage;if(elementOffsetTop>scrollTop){percentage=0;}else if((elementOffsetTop+elementHeight)<scrollTop){percentage=1;}else{percentage=(scrollTop-elementOffsetTop)/(elementHeight*this.options.threshold);}
this.visibility=percentage;this.requestTick();};Crossfade.prototype.onResize=function(){this.needsResize=true;this.width=this.el.width();this.height=this.el.height();this.requestTick();};Crossfade.prototype.requestTick=function(){var self=this;if(!this.ticking){window.requestAnimFrame(function(){self.draw();});}
this.ticking=true;};$.extend($.fn,{crossfade:function(options){var opts=$.extend({},$.fn.crossfade.defaults,options);return this.each(function(){$(this).data('crossfade',new Crossfade(this,opts));return this;});}});$.fn.crossfade.defaults={backgroundPosition:'center center',threshold:0.5};window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(callback){window.setTimeout(callback,1000/60);};})();}));